<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Upload Policy ‚Äî Mizan Rules Engine</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#060C18;color:#fff;display:flex;min-height:100vh}
.sidebar{width:240px;background:#0B1F3A;padding:24px 0;display:flex;flex-direction:column;position:fixed;height:100vh}
.sidebar .logo{padding:0 24px 24px;font-size:24px;font-weight:700;color:#D4AF37;border-bottom:1px solid rgba(212,175,55,.2)}
.sidebar nav{flex:1;padding:16px 0}
.sidebar nav a{display:flex;align-items:center;gap:10px;padding:12px 24px;color:rgba(255,255,255,.7);text-decoration:none;font-size:14px;transition:all .2s}
.sidebar nav a:hover,.sidebar nav a.active{color:#D4AF37;background:rgba(212,175,55,.08)}
.sidebar nav a.active{border-right:3px solid #D4AF37}
.main{margin-left:240px;flex:1;padding:40px;max-width:900px}
h1{font-size:28px;margin-bottom:8px}
h1 .gold{color:#D4AF37}
.subtitle{color:rgba(255,255,255,.5);margin-bottom:32px}
textarea{width:100%;height:200px;background:rgba(11,31,58,.6);border:1px solid rgba(212,175,55,.2);border-radius:8px;padding:16px;color:#fff;font-family:'Inter',sans-serif;font-size:14px;resize:vertical}
textarea:focus{outline:none;border-color:#D4AF37}
.actions{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
.btn{padding:12px 24px;background:#D4AF37;color:#0B1F3A;font-weight:600;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-family:'Inter',sans-serif}
.btn:hover{background:#c9a430}
.btn-outline{background:transparent;border:1px solid rgba(212,175,55,.4);color:#D4AF37}
.btn-outline:hover{background:rgba(212,175,55,.1)}
.loading{display:none;text-align:center;padding:40px;color:#D4AF37}
.loading.show{display:block}
.spinner{display:inline-block;width:32px;height:32px;border:3px solid rgba(212,175,55,.2);border-top-color:#D4AF37;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#results{margin-top:32px}
.rule-card{background:rgba(11,31,58,.6);border:1px solid rgba(212,175,55,.15);border-radius:8px;padding:20px;margin-bottom:12px}
.rule-card h3{color:#D4AF37;font-size:15px;margin-bottom:8px}
.rule-card .meta{display:flex;gap:12px;flex-wrap:wrap;font-size:13px;color:rgba(255,255,255,.5)}
.rule-card .meta span{background:rgba(212,175,55,.1);padding:2px 10px;border-radius:4px}
.badge{display:inline-block;padding:3px 10px;border-radius:4px;font-size:12px;font-weight:600}
.badge.approved{background:rgba(34,197,94,.15);color:#22c55e}
.badge.rejected{background:rgba(239,68,68,.15);color:#ef4444}
.badge.review{background:rgba(234,179,8,.15);color:#eab308}
.save-bar{margin-top:24px;padding:20px;background:rgba(11,31,58,.4);border-radius:8px;display:none;text-align:center}
.save-bar.show{display:block}
.toast{position:fixed;top:20px;right:20px;background:#22c55e;color:#fff;padding:12px 24px;border-radius:8px;display:none;font-weight:600;z-index:100}
.toast.show{display:block}
.demo-label{background:rgba(234,179,8,.15);color:#eab308;padding:4px 12px;border-radius:4px;font-size:12px;font-weight:600;display:none}
.demo-label.show{display:inline-block}
</style>
</head>
<body>
<div class="sidebar">
  <div class="logo"><span>‚öñÔ∏è</span> Mizan</div>
  <nav>
    <a href="/">üè† Home</a>
    <a href="/upload.html" class="active">üìÑ Upload Policy</a>
    <a href="/rules.html">‚úèÔ∏è Rule Editor</a>
    <a href="/decide.html">üß™ Test Decision</a>
    <a href="/audit.html">üìä Audit Log</a>
    <a href="/api-docs.html">üìö API Docs</a>
  </nav>
</div>
<div class="main">
  <h1>üìÑ <span class="gold">Upload Policy</span></h1>
  <p class="subtitle">Paste policy or regulation text to extract structured rules <span class="demo-label" id="demoLabel">DEMO MODE</span></p>
  <textarea id="policyText" placeholder="Paste your policy text here...&#10;&#10;Example: All commercial license applicants must have a minimum capital of AED 50,000. Applications from blacklisted entities shall be rejected."></textarea>
  <div class="actions">
    <button class="btn" onclick="extractRules()">ü§ñ Extract Rules</button>
    <button class="btn btn-outline" onclick="loadDemo()">üì¶ Load Demo</button>
    <button class="btn btn-outline" onclick="document.getElementById('policyText').value=''">üóëÔ∏è Clear</button>
  </div>
  <div class="loading" id="loading"><div class="spinner"></div><p style="margin-top:12px">Extracting rules from policy text...</p></div>
  <div id="results"></div>
  <div class="save-bar" id="saveBar">
    <p style="margin-bottom:12px;color:rgba(255,255,255,.6)"><span id="ruleCount">0</span> rules extracted</p>
    <button class="btn" onclick="saveRules()">üíæ Save All Rules</button>
  </div>
</div>
<div class="toast" id="toast"></div>
<script>
let extractedRules = [];
function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
async function extractRules() {
  const text = document.getElementById('policyText').value.trim();
  if (!text) return showToast('Please paste policy text first');
  document.getElementById('loading').classList.add('show');
  document.getElementById('results').innerHTML = '';
  document.getElementById('saveBar').classList.remove('show');
  try {
    const res = await fetch('/api/extract', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text}) });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    extractedRules = data.rules || [];
    renderRules();
    showToast(`${extractedRules.length} rules extracted (${data.source})`);
  } catch(e) { showToast('Error: '+e.message); }
  document.getElementById('loading').classList.remove('show');
}
function renderRules() {
  const el = document.getElementById('results');
  if (!extractedRules.length) { el.innerHTML='<p style="color:rgba(255,255,255,.4);padding:20px">No rules extracted</p>'; return; }
  el.innerHTML = extractedRules.map(r => `
    <div class="rule-card">
      <h3>${r.name}</h3>
      <p style="margin-bottom:8px;font-size:13px;color:rgba(255,255,255,.7)"><strong>IF:</strong> ${r.condition}</p>
      <div class="meta">
        <span class="badge ${r.action.toLowerCase()}">${r.action}</span>
        <span>Priority: ${r.priority || 1}</span>
      </div>
      <p style="margin-top:8px;font-size:13px;color:rgba(255,255,255,.5)">${r.reason || ''}</p>
    </div>
  `).join('');
  document.getElementById('saveBar').classList.add('show');
  document.getElementById('ruleCount').textContent = extractedRules.length;
}
async function saveRules() {
  let saved = 0;
  for (const r of extractedRules) {
    await fetch('/api/rules', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(r) });
    saved++;
  }
  showToast(`${saved} rules saved!`);
  extractedRules = [];
  document.getElementById('saveBar').classList.remove('show');
}
async function loadDemo() {
  await fetch('/api/demo/load', { method:'POST' });
  document.getElementById('policyText').value = `UAE Commercial License Regulations (Simplified)\n\n1. All applicants must have a minimum capital of AED 50,000.\n2. Restricted activities require additional ministerial approval.\n3. Applications from blacklisted entities shall be rejected.\n4. Trade name must be pre-approved by DED.\n5. Foreign ownership exceeding 49% requires free zone registration or exemption.`;
  document.getElementById('demoLabel').classList.add('show');
  const res = await fetch('/api/rules');
  extractedRules = await res.json();
  renderRules();
  showToast('Demo loaded ‚Äî 5 rules + 3 decisions');
}
</script>
</body>
</html>