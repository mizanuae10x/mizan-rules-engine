<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rule Editor ‚Äî Mizan Rules Engine</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#060C18;color:#fff;display:flex;min-height:100vh}
.sidebar{width:240px;background:#0B1F3A;padding:24px 0;display:flex;flex-direction:column;position:fixed;height:100vh}
.sidebar .logo{padding:0 24px 24px;font-size:24px;font-weight:700;color:#D4AF37;border-bottom:1px solid rgba(212,175,55,.2)}
.sidebar nav{flex:1;padding:16px 0}
.sidebar nav a{display:flex;align-items:center;gap:10px;padding:12px 24px;color:rgba(255,255,255,.7);text-decoration:none;font-size:14px;transition:all .2s}
.sidebar nav a:hover,.sidebar nav a.active{color:#D4AF37;background:rgba(212,175,55,.08)}
.sidebar nav a.active{border-right:3px solid #D4AF37}
.main{margin-left:240px;flex:1;padding:40px;max-width:1000px}
h1{font-size:28px;margin-bottom:8px} h1 .gold{color:#D4AF37}
.subtitle{color:rgba(255,255,255,.5);margin-bottom:24px}
.toolbar{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}
.btn{padding:10px 20px;background:#D4AF37;color:#0B1F3A;font-weight:600;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-family:'Inter',sans-serif}
.btn:hover{background:#c9a430}
.btn-outline{background:transparent;border:1px solid rgba(212,175,55,.4);color:#D4AF37}
.btn-outline:hover{background:rgba(212,175,55,.1)}
.btn-danger{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)}
.rule-card{background:rgba(11,31,58,.6);border:1px solid rgba(212,175,55,.15);border-radius:8px;padding:20px;margin-bottom:12px;position:relative}
.rule-card.inactive{opacity:.5}
.rule-card h3{color:#D4AF37;font-size:15px;margin-bottom:8px}
.rule-card .field{margin-bottom:8px}
.rule-card label{font-size:12px;color:rgba(255,255,255,.4);display:block;margin-bottom:4px}
.rule-card input,.rule-card select{width:100%;background:rgba(6,12,24,.6);border:1px solid rgba(212,175,55,.2);border-radius:6px;padding:8px 12px;color:#fff;font-family:'Inter',sans-serif;font-size:13px}
.rule-card input:focus,.rule-card select:focus{outline:none;border-color:#D4AF37}
.rule-actions{display:flex;gap:8px;margin-top:12px;justify-content:flex-end}
.rule-actions button{padding:6px 14px;font-size:12px;border-radius:6px;cursor:pointer;font-family:'Inter',sans-serif;border:none}
.badge{display:inline-block;padding:3px 10px;border-radius:4px;font-size:12px;font-weight:600}
.badge.approved{background:rgba(34,197,94,.15);color:#22c55e}
.badge.rejected{background:rgba(239,68,68,.15);color:#ef4444}
.badge.review{background:rgba(234,179,8,.15);color:#eab308}
.conflict-card{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:16px;margin-bottom:12px}
.conflict-card h4{color:#ef4444;font-size:14px;margin-bottom:6px}
.conflict-card p{font-size:13px;color:rgba(255,255,255,.6)}
.conflict-card .suggestion{color:#D4AF37;font-style:italic;margin-top:4px}
#conflicts{margin-top:24px}
.toast{position:fixed;top:20px;right:20px;background:#22c55e;color:#fff;padding:12px 24px;border-radius:8px;display:none;font-weight:600;z-index:100}
.toast.show{display:block}
.empty{text-align:center;padding:60px;color:rgba(255,255,255,.3)}
.toggle{width:40px;height:22px;background:rgba(255,255,255,.2);border-radius:11px;position:relative;cursor:pointer;display:inline-block;vertical-align:middle}
.toggle.on{background:rgba(34,197,94,.6)}
.toggle::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:2px;left:2px;transition:.2s}
.toggle.on::after{left:20px}
</style>
<link rel="stylesheet" href="mobile.css">
</head>
<body>
<button class="mobile-toggle" onclick="toggleSidebar()" aria-label="Menu">‚ò∞</button>
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>
<div class="sidebar">
  <div class="logo"><span>‚öñÔ∏è</span> Mizan</div>
  <nav>
    <a href="/">üè† Home</a>
    <a href="/upload.html">üìÑ Upload Policy</a>
    <a href="/rules.html" class="active">‚úèÔ∏è Rule Editor</a>
    <a href="/decide.html">üß™ Test Decision</a>
    <a href="/audit.html">üìä Audit Log</a>
    <a href="/api-docs.html">üìö API Docs</a>
  </nav>
</div>
<div class="main">
  <h1>‚úèÔ∏è <span class="gold">Rule Editor</span></h1>
  <p class="subtitle">Manage, edit, and validate your rules</p>
  <div class="toolbar">
    <button class="btn" onclick="addRule()">‚ûï Add Rule</button>
    <button class="btn btn-outline" onclick="checkConflicts()">üîç Check Conflicts</button>
    <button class="btn btn-outline" onclick="loadRules()">üîÑ Refresh</button>
  </div>
  <div id="rulesList"></div>
  <div id="conflicts"></div>
</div>
<div class="toast" id="toast"></div>
<script>
let rules = [];
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
async function loadRules(){
  rules = await(await fetch('/api/rules')).json();
  render();
}
function render(){
  const el=document.getElementById('rulesList');
  if(!rules.length){el.innerHTML='<div class="empty"><p>No rules yet</p><p style="margin-top:8px;font-size:14px">Upload a policy or add rules manually</p></div>';return}
  el.innerHTML=rules.map((r,i)=>`
    <div class="rule-card ${r.active?'':'inactive'}" id="rule-${r.id}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3>${r.name||'Unnamed Rule'}</h3>
        <div style="display:flex;align-items:center;gap:12px">
          <span class="badge ${(r.action||'review').toLowerCase()}">${r.action||'REVIEW'}</span>
          <div class="toggle ${r.active?'on':''}" onclick="toggleRule('${r.id}',${r.active?'false':'true'})"></div>
        </div>
      </div>
      <div class="field"><label>Name</label><input value="${esc(r.name)}" onchange="updateField('${r.id}','name',this.value)"></div>
      <div class="field"><label>Condition (IF)</label><input value="${esc(r.condition)}" onchange="updateField('${r.id}','condition',this.value)"></div>
      <div class="field"><label>Action</label><select onchange="updateField('${r.id}','action',this.value)">
        <option value="APPROVED" ${r.action==='APPROVED'?'selected':''}>APPROVED</option>
        <option value="REJECTED" ${r.action==='REJECTED'?'selected':''}>REJECTED</option>
        <option value="REVIEW" ${r.action==='REVIEW'?'selected':''}>REVIEW</option>
      </select></div>
      <div class="field"><label>Reason</label><input value="${esc(r.reason||'')}" onchange="updateField('${r.id}','reason',this.value)"></div>
      <div class="field"><label>Priority</label><input type="number" min="1" max="10" value="${r.priority||1}" onchange="updateField('${r.id}','priority',parseInt(this.value))"></div>
      <div class="rule-actions">
        <button class="btn" style="padding:6px 14px;font-size:12px" onclick="saveRule('${r.id}')">üíæ Save</button>
        <button class="btn-danger" style="padding:6px 14px;font-size:12px;cursor:pointer" onclick="deleteRule('${r.id}')">üóëÔ∏è Delete</button>
      </div>
    </div>
  `).join('');
}
function esc(s){return(s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;')}
async function updateField(id,field,val){
  const r=rules.find(x=>x.id===id);
  if(r)r[field]=val;
}
async function saveRule(id){
  const r=rules.find(x=>x.id===id);
  if(!r)return;
  await fetch(`/api/rules/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(r)});
  showToast('Rule saved');
}
async function deleteRule(id){
  if(!confirm('Delete this rule?'))return;
  await fetch(`/api/rules/${id}`,{method:'DELETE'});
  showToast('Rule deleted');
  loadRules();
}
async function toggleRule(id,active){
  const r=rules.find(x=>x.id===id);
  if(r){r.active=active==='true'||active===true;await saveRule(id);render();}
}
function addRule(){
  const newRule={name:'New Rule',condition:'',action:'REVIEW',reason:'',priority:1,active:true};
  fetch('/api/rules',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(newRule)}).then(()=>{loadRules();showToast('Rule added')});
}
async function checkConflicts(){
  const conflicts=await(await fetch('/api/conflicts')).json();
  const el=document.getElementById('conflicts');
  if(!conflicts.length){el.innerHTML='<div style="padding:20px;text-align:center;color:#22c55e">‚úÖ No conflicts detected</div>';return}
  el.innerHTML='<h2 style="color:#ef4444;margin-bottom:12px">‚ö†Ô∏è Conflicts Found</h2>'+conflicts.map(c=>`
    <div class="conflict-card">
      <h4>${c.type==='contradictory'?'üî¥ Contradiction':'üü° Duplicate'}: ${c.ruleNames.join(' ‚Üî ')}</h4>
      <p>${c.explanation}</p>
      <p class="suggestion">üí° ${c.suggestion}</p>
    </div>
  `).join('');
}
loadRules();
</script>
</body>
</html>